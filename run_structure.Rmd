```{r structure_pipeline}
library(parallel)
library(starmie)
set.seed(666351)
# prelim setup
# number of Ks to try
structure_binary <- "/usr/local/bioinf/bin/structure"
# run structure in parallel
n.cores <- 20
tryK <- 2L:20L
n.runs <- 1L:20L
mainparams <- "./structure_output/mainparams"
extraparams <- "./structure_output/extraparams"
extraparamsLinked <- "./structure_output/extraparamsLinkage"
unlinked_file <- "cache/png_unlinked.str"
unlinked_map <- "cache/png_unlinked.map"
complete_file <- "cache/png_complete.str"


stopifnot(file.exists(unlinked_file))
stopifnot(file.exists(complete_file))
stopifnot(file.exists(mainparams))
stopifnot(file.exists(extraparams))
stopifnot(file.exists(extraparamsLinked))


strsplit(system
strout_gen <- function(prefix, x,y) {
  paste0(prefix, stringr::str_pad(x, width = 2, pad = 0), 
    "_K_", stringr::str_pad(y, width = 2, pad = 0), ".out")
}
# output files (will be appended by out_f from structure)
out_files <- outer(n.runs, tryK, 
  function(x,y) strout_gen("str_run_unlinked", x, y))

log_files <- gsub("out", "log", out_files)

N <- strsplit(system(paste("wc -l", unlinked_file)))[[1]][1]
nsnps <- strsplit(system(paste("wc -l", unlinked_map)))[[1]][1]

# create function to run structure, we will curry it to setup our two models
run_structure <- function(out_file, log_file, mp, ep, n, l) {
  k <- as.integer(stringr::str_extract(out_file, "[0-9]{2}\\b"))
  paste(structure_binary, "-K", k, "-L" l,,  "-N", n, "-m" mainparams, "-e", extraparams, 
    "-D", round(runif(1) * 1e8), "-o", out_file, "&>", log_file)
}

unlinked_run <- function(out_file, log_file) {
  cat(run_structure(out_file, log_file, mainparams, extraparams, N, snps))
}


cat("Running unlinked model\n")


st_runs <- mcmapply(unlinked_run, out_files, log_files, 
                    mc.cores = n.cores, mc.set.seed = TRUE)

str_filelist <- mapply(loadStructure, paste0(out_files, "_f"), 
                       log_files, SIMPLIFY = FALSE)

# save parsed output
saveRDS(str_filelist, file = "structure_output/unlinked_model.rds")

system("rm *.out_f structure_runs/")
system("rm *.log structure_runs/")
system("mv seed.txt structure_output/")

```
